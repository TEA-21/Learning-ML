{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":8988,"status":"ok","timestamp":1759242359492,"user":{"displayName":"Taanush abraham","userId":"16497560746847074205"},"user_tz":-330},"id":"cOwqlxu7SrZP","outputId":"1559cb8b-217b-45db-f000-b489e88c1d26"},"outputs":[{"name":"stdout","output_type":"stream","text":["Requirement already satisfied: opencv-python-headless in /usr/local/lib/python3.12/dist-packages (4.12.0.88)\n","Collecting pytesseract\n","  Downloading pytesseract-0.3.13-py3-none-any.whl.metadata (11 kB)\n","Requirement already satisfied: numpy\u003c2.3.0,\u003e=2 in /usr/local/lib/python3.12/dist-packages (from opencv-python-headless) (2.0.2)\n","Requirement already satisfied: packaging\u003e=21.3 in /usr/local/lib/python3.12/dist-packages (from pytesseract) (25.0)\n","Requirement already satisfied: Pillow\u003e=8.0.0 in /usr/local/lib/python3.12/dist-packages (from pytesseract) (11.3.0)\n","Downloading pytesseract-0.3.13-py3-none-any.whl (14 kB)\n","Installing collected packages: pytesseract\n","Successfully installed pytesseract-0.3.13\n"]}],"source":["!pip install opencv-python-headless pytesseract"]},{"cell_type":"code","execution_count":2,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":174},"executionInfo":{"elapsed":12,"status":"ok","timestamp":1759242359507,"user":{"displayName":"Taanush abraham","userId":"16497560746847074205"},"user_tz":-330},"id":"8ajpzHlu7fjc","outputId":"79d9bcd0-785d-4b88-c274-04605b2cdb82"},"outputs":[{"data":{"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"},"text/plain":["'def find_custom_markers(image, thresh_size, aspect_ratio_tolerance):\\n    # Step 1: Convert to Grayscale and Blur\\n    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\\n    blurred = cv2.GaussianBlur(gray, (5, 5), 0)\\n\\n    cv2_imshow(\"1. Grayscale and Blurred Image\", blurred)\\n    # cv2.waitKey(0)\\n\\n    # Step 2: Adaptive Thresholding\\n    thresh = cv2.adaptiveThreshold(blurred, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,\\n                                   cv2.THRESH_BINARY_INV, 401, 4)\\n\\n    cv2_imshow(\"2. Adaptive Threshold Result\", thresh)\\n    # cv2.waitKey(0)\\n\\n    # Step 3: Find Contours\\n    contours, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)\\n\\n    # Visualize all detected contours (before any filtering)\\n    image_all_contours = image.copy()\\n    cv2.drawContours(image_all_contours, contours, -1, (0, 255, 0), 2)\\n    cv2_imshow(f\"3. All {len(contours)} Detected Contours\", image_all_contours)\\n    # cv2.waitKey(0)\\n\\n    valid_marker_corners = []\\n    potential_marker_areas = []\\n    potential_markers=[]\\n\\n    # --- First Pass: Collect potential marker areas to calculate median ---\\n    # This step doesn\\'t filter by aspect ratio or convexity yet, only by approxPolyDP length and raw area.\\n    image_pass1_filtered_contours = image.copy()\\n    pass1_contours_count = 0\\n\\n    for i, contour in enumerate(contours):\\n        perimeter = cv2.arcLength(contour, True)\\n        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\\n\\n        # Filter by approximate number of vertices\\n        if len(approx) \u003e= 3 and len(approx) \u003c= 5: # Keep shapes that are somewhat rectangular/polygonal\\n            area = cv2.contourArea(contour)\\n            if 500 \u003c area \u003c 500000: # Broad area filter\\n                 potential_marker_areas.append(area)\\n                 potential_markers.append(contour)\\n                 cv2.drawContours(image_pass1_filtered_contours, [contour], -1, (0, 255, 255), 2) # Yellow\\n                 pass1_contours_count += 1\\n\\n    cv2_imshow(f\"4. Contours Passing Initial Approx/Area Filter ({pass1_contours_count} found)\", image_pass1_filtered_contours)\\n    # cv2.waitKey(0)\\n\\n    if not potential_marker_areas:\\n        print(\"No potential marker areas found in the first pass.\")\\n        cv2.destroyAllWindows()\\n        return []\\n\\n\\n    expected_pattern_template = np.array([\\n        [0, 1, 0],\\n        [1, 0, 1],\\n        [0, 1, 0]\\n    ], dtype=np.uint8)\\n\\n    marker_warp_size = 90\\n    max_sad_tolerance = 4\\n\\n    # --- Second Pass: Apply more rigorous filters and pattern matching ---\\n    image_pass2_filtered_contours = image.copy()\\n    pass2_contours_count = 0\\n\\n    for i, contour in enumerate(potential_markers):\\n        area = cv2.contourArea(contour)\\n\\n        perimeter = cv2.arcLength(contour, True)\\n        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\\n\\n        # Filter by number of vertices (again, as some might have been too complex in first pass)\\n        if not (len(approx) \u003e= 3 and len(approx) \u003c= 5):\\n            continue\\n\\n        # Filter by convexity\\n        if not cv2.isContourConvex(approx):\\n            print(f\"Contour {i}: Not convex. Skipping.\")\\n            continue\\n\\n        x, y, w, h = cv2.boundingRect(approx)\\n        aspect_ratio = float(w) / h\\n\\n        # Filter by aspect ratio\\n        if not (1 - aspect_ratio_tolerance \u003c= aspect_ratio \u003c= 1 + aspect_ratio_tolerance):\\n            print(f\"Contour {i}: Aspect ratio {aspect_ratio:.2f} out of tolerance. Skipping.\")\\n            continue\\n\\n        # At this point, the contour is a strong candidate for an outer marker. Draw it in blue.\\n        cv2.drawContours(image_pass2_filtered_contours, [contour], -1, (255, 0, 0), 2) # Blue\\n        pass2_contours_count += 1\\n\\n        # Determine points for perspective transform\\n        if len(approx) != 4:\\n            # If not exactly 4, use bounding box corners for warp (less accurate but fallback)\\n            marker_pts = np.float32([[x, y], [x + w, y], [x + w, y + h], [x, y + h]])\\n            print(f\"Contour {i}: Approximated contour has {len(approx)} vertices. Using bounding box for warp.\")\\n        else:\\n            marker_pts = approx.reshape(4, 2)\\n            print(f\"Contour {i}: Approximated contour has 4 vertices. Using approx for warp.\")\\n\\n        ordered_pts = order_points(marker_pts)\\n\\n        # Visualize the ordered points on the original image\\n        img_temp_corners = image.copy()\\n        for k, pt in enumerate(ordered_pts):\\n            cv2.circle(img_temp_corners, (int(pt[0]), int(pt[1])), 5, (0, 0, 255), -1) # Red circles\\n            cv2.putText(img_temp_corners, str(k), (int(pt[0]) + 10, int(pt[1]) + 10),\\n                        cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 255), 2)\\n        # cv2_imshow(f\"5. Contour {i} (Blue) \u0026 Ordered Points (Red)\", img_temp_corners)\\n        # cv2.waitKey(0)\\n\\n\\n        dst_pts = np.float32([\\n            [0, 0],\\n            [marker_warp_size - 1, 0],\\n            [marker_warp_size - 1, marker_warp_size - 1],\\n            [0, marker_warp_size - 1]\\n        ])\\n\\n        M_warp = cv2.getPerspectiveTransform(ordered_pts, dst_pts)\\n        warped_marker_gray = cv2.warpPerspective(gray, M_warp, (marker_warp_size, marker_warp_size))\\n\\n        cv2_imshow(f\"6. Warped Marker (Grayscale) for Contour {i}\", warped_marker_gray)\\n        # cv2.waitKey(0)\\n\\n        _, warped_marker_thresh = cv2.threshold(warped_marker_gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)\\n\\n        cv2_imshow(f\"7. Warped Marker (Thresholded) for Contour {i}\", warped_marker_thresh)\\n        # cv2.waitKey(0)\\n\\n        cell_size = marker_warp_size // 3\\n        current_marker_pattern = np.zeros((3, 3), dtype=np.uint8)\\n\\n        # Visualize the 3x3 grid and extracted pattern\\n        warped_marker_pattern_debug = cv2.cvtColor(warped_marker_thresh, cv2.COLOR_GRAY2BGR)\\n        for row in range(3):\\n            for col in range(3):\\n                cell_roi = warped_marker_thresh[row * cell_size:(row + 1) * cell_size,\\n                                                col * cell_size:(col + 1) * cell_size]\\n                avg_intensity = np.mean(cell_roi)\\n\\n                # Draw grid lines\\n                cv2.rectangle(warped_marker_pattern_debug,\\n                              (col * cell_size, row * cell_size),\\n                              ((col + 1) * cell_size - 1, (row + 1) * cell_size - 1),\\n                              (0, 255, 0), 1)\\n\\n                if avg_intensity \u003c 50:\\n                    current_marker_pattern[row, col] = 0\\n                    cv2.putText(warped_marker_pattern_debug, \"0\",\\n                                (col * cell_size + cell_size // 2 - 10, row * cell_size + cell_size // 2 + 10),\\n                                cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)\\n                elif avg_intensity \u003e 102:\\n                    current_marker_pattern[row, col] = 1\\n                    cv2.putText(warped_marker_pattern_debug, \"1\",\\n                                (col * cell_size + cell_size // 2 - 10, row * cell_size + cell_size // 2 + 10),\\n                                cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)\\n\\n        sad_score = np.sum(np.abs(current_marker_pattern - expected_pattern_template))\\n\\n        if sad_score \u003c= max_sad_tolerance:\\n            valid_marker_corners.append((sad_score, ordered_pts))\\n            print(f\"Contour {i}: Extracted Pattern:\\n{current_marker_pattern}\")\\n            cv2_imshow(f\"8. Warped Marker with Extracted Pattern for Contour {i}\", warped_marker_pattern_debug)\\n            print(f\"Contour {i}: SAD Score = {sad_score}. Max tolerance = {max_sad_tolerance}\")\\n            # cv2.waitKey(0)\\n            # Draw the final valid marker in magenta\\n            cv2.drawContours(image, [ordered_pts.reshape((-1, 1, 2)).astype(np.int32)], -1, (255, 0, 255), 3)\\n            print(f\"Contour {i}: Valid marker found!\")\\n        else:\\n            print(f\"Contour {i}: Pattern mismatch. SAD score too high.\")\\n\\n    cv2_imshow(f\"9. Final Valid Markers Detected (Magenta)\", image)\\n    # cv2.waitKey(0)\\n    cv2.destroyAllWindows() # Close all windows at the end\\n    # Sort candidates by SAD score (lower is better)\\n    valid_marker_corners.sort(key=lambda x: x[0])\\n    # Take the top 4 (or fewer if not enough)\\n    top_4_markers = []\\n    for marker_pts in valid_marker_corners[:4]:\\n        top_4_markers.append(marker_pts[1])\\n        cv2.drawContours(image, [marker_pts[1].reshape((-1, 1, 2)).astype(np.int32)], -1, (255, 0, 255), 3)\\n    return top_4_markers'"]},"execution_count":2,"metadata":{},"output_type":"execute_result"}],"source":["'''def find_custom_markers(image, thresh_size, aspect_ratio_tolerance):\n","    # Step 1: Convert to Grayscale and Blur\n","    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n","    blurred = cv2.GaussianBlur(gray, (5, 5), 0)\n","\n","    cv2_imshow(\"1. Grayscale and Blurred Image\", blurred)\n","    # cv2.waitKey(0)\n","\n","    # Step 2: Adaptive Thresholding\n","    thresh = cv2.adaptiveThreshold(blurred, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,\n","                                   cv2.THRESH_BINARY_INV, 401, 4)\n","\n","    cv2_imshow(\"2. Adaptive Threshold Result\", thresh)\n","    # cv2.waitKey(0)\n","\n","    # Step 3: Find Contours\n","    contours, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)\n","\n","    # Visualize all detected contours (before any filtering)\n","    image_all_contours = image.copy()\n","    cv2.drawContours(image_all_contours, contours, -1, (0, 255, 0), 2)\n","    cv2_imshow(f\"3. All {len(contours)} Detected Contours\", image_all_contours)\n","    # cv2.waitKey(0)\n","\n","    valid_marker_corners = []\n","    potential_marker_areas = []\n","    potential_markers=[]\n","\n","    # --- First Pass: Collect potential marker areas to calculate median ---\n","    # This step doesn't filter by aspect ratio or convexity yet, only by approxPolyDP length and raw area.\n","    image_pass1_filtered_contours = image.copy()\n","    pass1_contours_count = 0\n","\n","    for i, contour in enumerate(contours):\n","        perimeter = cv2.arcLength(contour, True)\n","        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\n","\n","        # Filter by approximate number of vertices\n","        if len(approx) \u003e= 3 and len(approx) \u003c= 5: # Keep shapes that are somewhat rectangular/polygonal\n","            area = cv2.contourArea(contour)\n","            if 500 \u003c area \u003c 500000: # Broad area filter\n","                 potential_marker_areas.append(area)\n","                 potential_markers.append(contour)\n","                 cv2.drawContours(image_pass1_filtered_contours, [contour], -1, (0, 255, 255), 2) # Yellow\n","                 pass1_contours_count += 1\n","\n","    cv2_imshow(f\"4. Contours Passing Initial Approx/Area Filter ({pass1_contours_count} found)\", image_pass1_filtered_contours)\n","    # cv2.waitKey(0)\n","\n","    if not potential_marker_areas:\n","        print(\"No potential marker areas found in the first pass.\")\n","        cv2.destroyAllWindows()\n","        return []\n","\n","\n","    expected_pattern_template = np.array([\n","        [0, 1, 0],\n","        [1, 0, 1],\n","        [0, 1, 0]\n","    ], dtype=np.uint8)\n","\n","    marker_warp_size = 90\n","    max_sad_tolerance = 4\n","\n","    # --- Second Pass: Apply more rigorous filters and pattern matching ---\n","    image_pass2_filtered_contours = image.copy()\n","    pass2_contours_count = 0\n","\n","    for i, contour in enumerate(potential_markers):\n","        area = cv2.contourArea(contour)\n","\n","        perimeter = cv2.arcLength(contour, True)\n","        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\n","\n","        # Filter by number of vertices (again, as some might have been too complex in first pass)\n","        if not (len(approx) \u003e= 3 and len(approx) \u003c= 5):\n","            continue\n","\n","        # Filter by convexity\n","        if not cv2.isContourConvex(approx):\n","            print(f\"Contour {i}: Not convex. Skipping.\")\n","            continue\n","\n","        x, y, w, h = cv2.boundingRect(approx)\n","        aspect_ratio = float(w) / h\n","\n","        # Filter by aspect ratio\n","        if not (1 - aspect_ratio_tolerance \u003c= aspect_ratio \u003c= 1 + aspect_ratio_tolerance):\n","            print(f\"Contour {i}: Aspect ratio {aspect_ratio:.2f} out of tolerance. Skipping.\")\n","            continue\n","\n","        # At this point, the contour is a strong candidate for an outer marker. Draw it in blue.\n","        cv2.drawContours(image_pass2_filtered_contours, [contour], -1, (255, 0, 0), 2) # Blue\n","        pass2_contours_count += 1\n","\n","        # Determine points for perspective transform\n","        if len(approx) != 4:\n","            # If not exactly 4, use bounding box corners for warp (less accurate but fallback)\n","            marker_pts = np.float32([[x, y], [x + w, y], [x + w, y + h], [x, y + h]])\n","            print(f\"Contour {i}: Approximated contour has {len(approx)} vertices. Using bounding box for warp.\")\n","        else:\n","            marker_pts = approx.reshape(4, 2)\n","            print(f\"Contour {i}: Approximated contour has 4 vertices. Using approx for warp.\")\n","\n","        ordered_pts = order_points(marker_pts)\n","\n","        # Visualize the ordered points on the original image\n","        img_temp_corners = image.copy()\n","        for k, pt in enumerate(ordered_pts):\n","            cv2.circle(img_temp_corners, (int(pt[0]), int(pt[1])), 5, (0, 0, 255), -1) # Red circles\n","            cv2.putText(img_temp_corners, str(k), (int(pt[0]) + 10, int(pt[1]) + 10),\n","                        cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 255), 2)\n","        # cv2_imshow(f\"5. Contour {i} (Blue) \u0026 Ordered Points (Red)\", img_temp_corners)\n","        # cv2.waitKey(0)\n","\n","\n","        dst_pts = np.float32([\n","            [0, 0],\n","            [marker_warp_size - 1, 0],\n","            [marker_warp_size - 1, marker_warp_size - 1],\n","            [0, marker_warp_size - 1]\n","        ])\n","\n","        M_warp = cv2.getPerspectiveTransform(ordered_pts, dst_pts)\n","        warped_marker_gray = cv2.warpPerspective(gray, M_warp, (marker_warp_size, marker_warp_size))\n","\n","        cv2_imshow(f\"6. Warped Marker (Grayscale) for Contour {i}\", warped_marker_gray)\n","        # cv2.waitKey(0)\n","\n","        _, warped_marker_thresh = cv2.threshold(warped_marker_gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)\n","\n","        cv2_imshow(f\"7. Warped Marker (Thresholded) for Contour {i}\", warped_marker_thresh)\n","        # cv2.waitKey(0)\n","\n","        cell_size = marker_warp_size // 3\n","        current_marker_pattern = np.zeros((3, 3), dtype=np.uint8)\n","\n","        # Visualize the 3x3 grid and extracted pattern\n","        warped_marker_pattern_debug = cv2.cvtColor(warped_marker_thresh, cv2.COLOR_GRAY2BGR)\n","        for row in range(3):\n","            for col in range(3):\n","                cell_roi = warped_marker_thresh[row * cell_size:(row + 1) * cell_size,\n","                                                col * cell_size:(col + 1) * cell_size]\n","                avg_intensity = np.mean(cell_roi)\n","\n","                # Draw grid lines\n","                cv2.rectangle(warped_marker_pattern_debug,\n","                              (col * cell_size, row * cell_size),\n","                              ((col + 1) * cell_size - 1, (row + 1) * cell_size - 1),\n","                              (0, 255, 0), 1)\n","\n","                if avg_intensity \u003c 50:\n","                    current_marker_pattern[row, col] = 0\n","                    cv2.putText(warped_marker_pattern_debug, \"0\",\n","                                (col * cell_size + cell_size // 2 - 10, row * cell_size + cell_size // 2 + 10),\n","                                cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)\n","                elif avg_intensity \u003e 102:\n","                    current_marker_pattern[row, col] = 1\n","                    cv2.putText(warped_marker_pattern_debug, \"1\",\n","                                (col * cell_size + cell_size // 2 - 10, row * cell_size + cell_size // 2 + 10),\n","                                cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)\n","\n","        sad_score = np.sum(np.abs(current_marker_pattern - expected_pattern_template))\n","\n","        if sad_score \u003c= max_sad_tolerance:\n","            valid_marker_corners.append((sad_score, ordered_pts))\n","            print(f\"Contour {i}: Extracted Pattern:\\n{current_marker_pattern}\")\n","            cv2_imshow(f\"8. Warped Marker with Extracted Pattern for Contour {i}\", warped_marker_pattern_debug)\n","            print(f\"Contour {i}: SAD Score = {sad_score}. Max tolerance = {max_sad_tolerance}\")\n","            # cv2.waitKey(0)\n","            # Draw the final valid marker in magenta\n","            cv2.drawContours(image, [ordered_pts.reshape((-1, 1, 2)).astype(np.int32)], -1, (255, 0, 255), 3)\n","            print(f\"Contour {i}: Valid marker found!\")\n","        else:\n","            print(f\"Contour {i}: Pattern mismatch. SAD score too high.\")\n","\n","    cv2_imshow(f\"9. Final Valid Markers Detected (Magenta)\", image)\n","    # cv2.waitKey(0)\n","    cv2.destroyAllWindows() # Close all windows at the end\n","    # Sort candidates by SAD score (lower is better)\n","    valid_marker_corners.sort(key=lambda x: x[0])\n","    # Take the top 4 (or fewer if not enough)\n","    top_4_markers = []\n","    for marker_pts in valid_marker_corners[:4]:\n","        top_4_markers.append(marker_pts[1])\n","        cv2.drawContours(image, [marker_pts[1].reshape((-1, 1, 2)).astype(np.int32)], -1, (255, 0, 255), 3)\n","    return top_4_markers'''"]},{"cell_type":"code","execution_count":3,"metadata":{"executionInfo":{"elapsed":590,"status":"ok","timestamp":1759242360098,"user":{"displayName":"Taanush abraham","userId":"16497560746847074205"},"user_tz":-330},"id":"M8EFUnpSNjHm"},"outputs":[],"source":["import re\n","import cv2\n","import json\n","import copy\n","import numpy as np\n","import pytesseract\n","from collections import defaultdict\n","\n","def order_points(pts):\n","    rect = np.zeros((4, 2), dtype=\"float32\")\n","    s = pts.sum(axis=1)\n","    rect[0] = pts[np.argmin(s)]\n","    rect[2] = pts[np.argmax(s)]\n","    diff = np.diff(pts, axis=1)\n","    rect[1] = pts[np.argmin(diff)]\n","    rect[3] = pts[np.argmax(diff)]\n","    return rect\n","\n","def find_custom_markers(image, thresh_size, aspect_ratio_tolerance = 1):\n","    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n","    blurred = cv2.GaussianBlur(gray, (5, 5), 0)\n","\n","    thresh = cv2.adaptiveThreshold(blurred, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,\n","                                   cv2.THRESH_BINARY_INV, thresh_size, 4)\n","\n","    contours, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)\n","\n","    valid_markers = []\n","    potential_marker_areas = []\n","    potential_markers=[]\n","\n","    for i, contour in enumerate(contours):\n","        perimeter = cv2.arcLength(contour, True)\n","        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\n","\n","        # Filter by approximate number of vertices\n","        if len(approx) \u003e= 3 and len(approx) \u003c= 5: # Keep shapes that are somewhat rectangular/polygonal\n","            area = cv2.contourArea(contour)\n","            if 500 \u003c area \u003c 500000: # Broad area filter\n","                 potential_marker_areas.append(area)\n","                 potential_markers.append(contour)\n","\n","    if not potential_marker_areas:\n","        print(\"No potential marker areas found in the first pass.\")\n","        cv2.destroyAllWindows()\n","        return []\n","\n","    expected_pattern_template = np.array([\n","        [0, 1, 0],\n","        [1, 0, 1],\n","        [0, 1, 0]\n","    ], dtype=np.uint8)\n","\n","    marker_warp_size = 90\n","    max_sad_tolerance = 4\n","\n","    for i, contour in enumerate(potential_markers):\n","        area = cv2.contourArea(contour)\n","\n","        perimeter = cv2.arcLength(contour, True)\n","        approx = cv2.approxPolyDP(contour, 0.03 * perimeter, True)\n","\n","        if not (len(approx) \u003e= 3 and len(approx) \u003c= 5):\n","            continue\n","\n","        if not cv2.isContourConvex(approx):\n","            continue\n","        x, y, w, h = cv2.boundingRect(approx)\n","        aspect_ratio = float(w) / h\n","\n","        if not (1 - aspect_ratio_tolerance \u003c= aspect_ratio \u003c= 1 + aspect_ratio_tolerance):\n","            continue\n","\n","        if len(approx) != 4:\n","            marker_pts = np.float32([[x, y], [x + w, y], [x + w, y + h], [x, y + h]])\n","        else:\n","            marker_pts = approx.reshape(4, 2)\n","\n","        ordered_pts = order_points(marker_pts)\n","\n","        dst_pts = np.float32([\n","            [0, 0],\n","            [marker_warp_size - 1, 0],\n","            [marker_warp_size - 1, marker_warp_size - 1],\n","            [0, marker_warp_size - 1]\n","        ])\n","\n","        M_warp = cv2.getPerspectiveTransform(ordered_pts, dst_pts)\n","        warped_marker_gray = cv2.warpPerspective(gray, M_warp, (marker_warp_size, marker_warp_size))\n","\n","        _, warped_marker_thresh = cv2.threshold(warped_marker_gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)\n","\n","        cell_size = marker_warp_size // 3\n","        current_marker_pattern = np.zeros((3, 3), dtype=np.uint8)\n","\n","        for row in range(3):\n","            for col in range(3):\n","                cell_roi = warped_marker_thresh[row * cell_size:(row + 1) * cell_size,\n","                                                 col * cell_size:(col + 1) * cell_size]\n","                avg_intensity = np.mean(cell_roi)\n","                if avg_intensity \u003c 70:\n","                    current_marker_pattern[row, col] = 0\n","                elif avg_intensity \u003e 102:\n","                    current_marker_pattern[row, col] = 1\n","                else:\n","                    current_marker_pattern[row, col] = 2\n","\n","        sad_score = np.sum(np.abs(current_marker_pattern - expected_pattern_template))\n","\n","        if sad_score \u003c= max_sad_tolerance:\n","            valid_markers.append((sad_score, ordered_pts))\n","            print(f\"Contour {i}: Valid marker candidate found with SAD score {sad_score}!\")\n","            print(f\"Contour {i}: Extracted Pattern:\\n{current_marker_pattern}\")\n","            print(f\"Contour {i}: SAD Score = {sad_score}. Max tolerance = {max_sad_tolerance}\")\n","\n","    # Take the top 4 (or fewer if not enough)\n","    top_4_markers = [markers[1] for markers in valid_markers if markers[0] == 0]\n","    if len(top_4_markers) \u003e= 4:\n","        return top_4_markers\n","    else:\n","        # Sort candidates by SAD score (lower is better)\n","        valid_markers.sort(key=lambda x: x[0])\n","        top_4_markers = []\n","        for marker_pts in valid_markers[:4]:\n","            top_4_markers.append(marker_pts[1])\n","            cv2.drawContours(image, [marker_pts[1].reshape((-1, 1, 2)).astype(np.int32)], -1, (255, 0, 255), 3)\n","        return top_4_markers\n","\n","def deskew_document(image_path, thresh_size, aspect_ratio_tolerance, osd):\n","    img = cv2.imread(image_path)\n","    if img is None:\n","        print(f\"Error: Could not load image {image_path}. Please check the path.\")\n","        return None\n","\n","    # Store original dimensions for comparison\n","    original_height, original_width = img.shape[:2]\n","\n","    all_markers = find_custom_markers(img, thresh_size, aspect_ratio_tolerance = 1)\n","\n","    if len(all_markers) \u003c 4:\n","        print(f\"Error: Only {len(all_markers)} valid fiducial markers found. Need 4 for accurate deskewing.\")\n","        print(\"Please ensure all four corner markers are clearly visible and distinct in the image.\")\n","        return None\n","\n","    all_marker_points = np.vstack(all_markers)\n","    source_points = order_points(all_marker_points)\n","\n","    (tl, tr, br, bl) = source_points\n","\n","    widthA = np.sqrt(((br[0] - bl[0]) ** 2) + ((br[1] - bl[1]) ** 2))\n","    widthB = np.sqrt(((tr[0] - tl[0]) ** 2) + ((tr[1] - tl[1]) ** 2))\n","    maxWidth = max(int(widthA), int(widthB))\n","\n","    heightA = np.sqrt(((tr[0] - br[0]) ** 2) + ((tr[1] - br[1]) ** 2))\n","    heightB = np.sqrt(((tl[0] - bl[0]) ** 2) + ((tl[1] - bl[1]) ** 2))\n","    maxHeight = max(int(heightA), int(heightB))\n","\n","    min_expected_dim = max(original_width, original_height) * 0.25\n","    max_expected_dim = max(original_width, original_height) * 4.0\n","\n","    if not (min_expected_dim \u003c maxWidth \u003c max_expected_dim and \\\n","            min_expected_dim \u003c maxHeight \u003c max_expected_dim):\n","        print(f\"Warning: Calculated deskewed dimensions ({maxWidth}x{maxHeight}) seem unusual compared to original ({original_width}x{original_height}).\")\n","        print(\"This might be a issue with fiducial marker detection. Please ensure the markers are clearly visible and properly formed.\")\n","\n","    destination_points = np.float32([\n","        [0, 0],\n","        [maxWidth - 1, 0],\n","        [maxWidth - 1, maxHeight - 1],\n","        [0, maxHeight - 1]\n","    ])\n","\n","    M = cv2.getPerspectiveTransform(source_points, destination_points)\n","    warped_img = cv2.warpPerspective(img, M, (maxWidth, maxHeight))\n","\n","    if osd == True and warped_img.shape[1] \u003e warped_img.shape[0]:\n","        warped_img = cv2.rotate(warped_img, cv2.ROTATE_90_CLOCKWISE)\n","        try:\n","            warped_gray = cv2.cvtColor(warped_img, cv2.COLOR_BGR2GRAY)\n","            osd = pytesseract.image_to_osd(warped_gray)\n","\n","            rotation_angle = 0\n","            for line in osd.split('\\n'):\n","                if line.startswith('Rotate:'):\n","                    try:\n","                        rotation_angle = int(line.split(': ')[1])\n","                        break\n","                    except ValueError:\n","                        pass\n","\n","            if rotation_angle == 90:\n","                warped_img = cv2.rotate(warped_img, cv2.ROTATE_90_CLOCKWISE)\n","            elif rotation_angle == 180:\n","                warped_img = cv2.rotate(warped_img, cv2.ROTATE_180)\n","            elif rotation_angle == 270:\n","                warped_img = cv2.rotate(warped_img, cv2.ROTATE_90_COUNTERCLOCKWISE)\n","\n","        except pytesseract.TesseractNotFoundError:\n","            print(\"Tesseract is not installed or not in your PATH. Cannot correct for upside-down orientation.\")\n","        except Exception as e:\n","            print(f\"An error occurred during OCR orientation detection: {e}\")\n","\n","    return warped_img\n","\n","def cv2_imshow(title, image):\n","    try:\n","        from google.colab.patches import cv2_imshow as colab_cv2_imshow\n","        print(title)\n","        colab_cv2_imshow(image)\n","    except ImportError:\n","        cv2.imshow(title, image)\n","\n","def preprocess_image(image):\n","    if image is None:\n","        raise ValueError(\"Image is None.\")\n","    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n","    blurred = cv2.GaussianBlur(gray, (5, 5), 0)\n","    thresh = cv2.adaptiveThreshold(blurred, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C,\n","                                   cv2.THRESH_BINARY_INV, 93, 4)\n","    cv2_imshow(\"thresh\", thresh)\n","    return image, thresh\n","\n","\n","def get_contour_center(contour):\n","    M = cv2.moments(contour)\n","    if M[\"m00\"] != 0:\n","        cx = int(M[\"m10\"] / M[\"m00\"])\n","        cy = int(M[\"m01\"] / M[\"m00\"])\n","        return (cx, cy)\n","    return None\n","\n","\n","def remove_duplicate_contours(contours, min_distance_factor=0.5):\n","    if not contours:\n","        return []\n","\n","    contour_data = []\n","    all_areas = []\n","    for contour in contours:\n","        center = get_contour_center(contour)\n","        if center is not None:\n","            area = cv2.contourArea(contour)\n","            contour_data.append((contour, center, area))\n","            all_areas.append(area)\n","\n","    if not all_areas:\n","        return []\n","\n","    median_area = np.median(all_areas)\n","    median_radius = np.sqrt(median_area / np.pi)\n","\n","    min_distance = median_radius * min_distance_factor\n","    min_distance = max(10, min_distance)\n","\n","    contour_data.sort(key=lambda x: x[2], reverse=True)\n","\n","    filtered_contours = []\n","    used_centers = []\n","\n","    for contour, center, area in contour_data:\n","        is_duplicate = False\n","        for used_center in used_centers:\n","            distance = np.sqrt((center[0] - used_center[0]) ** 2 + (center[1] - used_center[1]) ** 2)\n","            if distance \u003c min_distance:\n","                is_duplicate = True\n","                break\n","\n","        if not is_duplicate:\n","            filtered_contours.append(contour)\n","            used_centers.append(center)\n","\n","    return filtered_contours\n","\n","\n","def find_bubble_contours(thresh_img):\n","    contours, _ = cv2.findContours(thresh_img.copy(), cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)\n","    potential_bubble_contours = []\n","    potential_bubble_areas = []\n","\n","    for contour in contours:\n","        area = cv2.contourArea(contour)\n","        if area \u003c 50 or area \u003e 10000:\n","            continue\n","\n","        perimeter = cv2.arcLength(contour, True)\n","        if perimeter == 0:\n","            continue\n","        circularity = 4 * np.pi * (area / (perimeter * perimeter))\n","\n","        x, y, w, h = cv2.boundingRect(contour)\n","        aspect_ratio = float(w) / h\n","        extent = area / (w * h)\n","\n","        hull = cv2.convexHull(contour)\n","        hull_area = cv2.contourArea(hull)\n","        solidity = float(area) / hull_area if hull_area \u003e 0 else 0\n","\n","        approx = cv2.approxPolyDP(contour, 0.02 * perimeter, True)\n","        vertex_count = len(approx)\n","\n","        if (0.5 \u003c circularity \u003c 1.3 and\n","            0.7 \u003c aspect_ratio \u003c 1.3 and\n","            extent \u003c 0.95 and\n","            solidity \u003e 0.8 and\n","            vertex_count \u003e 5):\n","            potential_bubble_contours.append(contour)\n","            potential_bubble_areas.append(area)\n","\n","    if not potential_bubble_contours:\n","        print(\"No potential bubble areas found in initial pass.\")\n","        return []\n","\n","    median_area = np.median(potential_bubble_areas)\n","\n","    dynamic_min_area = median_area * 0.67\n","    dynamic_max_area = median_area * 1.8\n","\n","    final_bubble_contours = []\n","    for contour in potential_bubble_contours:\n","        area = cv2.contourArea(contour)\n","        if dynamic_min_area \u003c area \u003c dynamic_max_area:\n","            final_bubble_contours.append(contour)\n","\n","    return remove_duplicate_contours(final_bubble_contours, min_distance_factor=0.5)\n","\n","\n","def load_template(template_path):\n","    try:\n","        with open(template_path, 'r') as f:\n","            template = json.load(f)\n","        print(f\"✅ Template loaded: {len(template['regions'])} regions found\")\n","        return template\n","    except Exception as e:\n","        print(f\"❌ Error loading template: {e}\")\n","        return None\n","\n","\n","def is_point_in_region(point, region_coords):\n","    x, y = point\n","    rx, ry, rw, rh = region_coords['x'], region_coords['y'], region_coords['width'], region_coords['height']\n","    buffer = 5\n","    return (rx - buffer) \u003c= x \u003c= (rx + rw + buffer) and (ry - buffer) \u003c= y \u003c= (ry + rh + buffer)\n","\n","\n","def map_contours_to_grid(contours_in_region, region):\n","    if not contours_in_region:\n","        return []\n","\n","    coords = region['coordinates']\n","    grid = region['grid']\n","    rows_expected, cols_expected = grid['rows'], grid['cols']\n","\n","    # Sort all contours by Y coordinate first for row detection\n","    contours_in_region.sort(key=lambda c: get_contour_center(c)[1] if get_contour_center(c) else float('inf'))\n","\n","    mapped_contours = []\n","\n","    # Step 1: Detect rows\n","    row_groups = []\n","    if rows_expected \u003e 0 and coords['height'] \u003e 0:\n","        avg_row_height = coords['height'] / rows_expected\n","        row_detection_threshold = avg_row_height * 0.4\n","    else:\n","        row_detection_threshold = 15\n","\n","    current_row_group = []\n","    last_center_y = -1\n","\n","    for contour in contours_in_region:\n","        center = get_contour_center(contour)\n","        if center is None:\n","            continue\n","\n","        if not current_row_group:\n","            current_row_group.append(contour)\n","            last_center_y = center[1]\n","        else:\n","            if abs(center[1] - last_center_y) \u003e row_detection_threshold:\n","                row_groups.append(current_row_group)\n","                current_row_group = [contour]\n","            else:\n","                current_row_group.append(contour)\n","            last_center_y = center[1]\n","\n","    if current_row_group:\n","        row_groups.append(current_row_group)\n","\n","    # Step 2: Detect column positions globally\n","    all_x_positions = []\n","    for row_group in row_groups:\n","        for contour in row_group:\n","            center = get_contour_center(contour)\n","            if center:\n","                all_x_positions.append(center[0])\n","\n","    if not all_x_positions:\n","        return []\n","\n","    # Calculate expected column width for clustering\n","    if cols_expected \u003e 0 and coords['width'] \u003e 0:\n","        avg_col_width = coords['width'] / cols_expected\n","        col_detection_threshold = avg_col_width * 0.4\n","    else:\n","        col_detection_threshold = 15\n","\n","    # Cluster X positions to find actual column centers\n","    all_x_positions.sort()\n","    column_centers = []\n","    current_cluster = [all_x_positions[0]]\n","\n","    for x in all_x_positions[1:]:\n","        if x - current_cluster[-1] \u003c= col_detection_threshold:\n","            current_cluster.append(x)\n","        else:\n","            # Finish current cluster, start new one\n","            column_centers.append(sum(current_cluster) / len(current_cluster))\n","            current_cluster = [x]\n","\n","    # Don't forget the last cluster\n","    if current_cluster:\n","        column_centers.append(sum(current_cluster) / len(current_cluster))\n","\n","    # Step 3: Map each contour to its row and column\n","    for r_idx, row_group in enumerate(row_groups):\n","        for contour in row_group:\n","            center = get_contour_center(contour)\n","            if center is None:\n","                continue\n","\n","            # Find the closest column center\n","            distances_to_cols = [abs(center[0] - col_center) for col_center in column_centers]\n","            closest_col_idx = distances_to_cols.index(min(distances_to_cols))\n","\n","            # Only accept if the distance is reasonable\n","            if min(distances_to_cols) \u003c= col_detection_threshold * 1.5:  # Allow some tolerance\n","                mapped_contours.append({\n","                    'contour': contour,\n","                    'center': center,\n","                    'grid_pos': (r_idx, closest_col_idx),\n","                    'row': r_idx,\n","                    'col': closest_col_idx\n","                })\n","            else:\n","                print(f\"Warning: Contour at {center} is too far from any detected column center\")\n","\n","    # Sort by row first, then by column\n","    mapped_contours.sort(key=lambda x: (x['row'], x['col']))\n","\n","    return mapped_contours\n","\n","\n","def classify_bubbles(thresh_image, contours, fill_percentage_threshold=0.21):\n","    results = []\n","\n","    for contour in contours:\n","        x, y, w, h = cv2.boundingRect(contour)\n","\n","        roi_x = x + int(w * 0.25)\n","        roi_y = y + int(h * 0.25)\n","        roi_w = int(w * 0.5)\n","        roi_h = int(h * 0.5)\n","\n","        central_roi = thresh_image[roi_y:roi_y + roi_h, roi_x:roi_x + roi_w]\n","\n","        filled_pixels = np.sum(central_roi == 0)\n","        total_pixels = central_roi.size\n","        fill_percentage = filled_pixels / total_pixels\n","\n","        is_filled = fill_percentage \u003c fill_percentage_threshold\n","\n","        results.append((contour, is_filled))\n","\n","    return results\n","\n","def generate_labels_and_decode(template, all_contours, thresh):\n","    results = {}\n","    labeled_contours = []\n","\n","    for region in template['regions']:\n","        region_name = region['name']\n","        region_type = region['type']\n","\n","        # Original coordinates from the template\n","        coords_from_template = region['coordinates']\n","\n","        # Prepare region_coords to be always in the dictionary format expected by is_point_in_region\n","        # This is the crucial correction point.\n","        if isinstance(coords_from_template, dict):\n","            # If it's already a dict like {x, y, width, height}, use it directly\n","            region_coords_for_check = coords_from_template\n","        elif isinstance(coords_from_template, (list, tuple)) and len(coords_from_template) == 4:\n","            # If it's a tuple/list (x1, y1, x2, y2), convert it to {x, y, width, height}\n","            # This assumes x1,y1 is top-left and x2,y2 is bottom-right\n","            x1, y1, x2, y2 = coords_from_template\n","            region_coords_for_check = {\n","                'x': x1,\n","                'y': y1,\n","                'width': x2 - x1,\n","                'height': y2 - y1\n","            }\n","        else:\n","            raise ValueError(f\"Unexpected coordinates format for region {region_name}: {coords_from_template}. Expected dict or 4-element list/tuple.\")\n","\n","\n","        grid = region['grid']\n","        row_labels = region.get('row_labels', [])\n","        col_labels = region.get('col_labels', [])\n","        question_offset = region.get('question_offset', 0)\n","\n","        # Filter contours that fall within the current region's coordinates\n","        # Pass the correctly formatted dictionary to is_point_in_region\n","        contours_in_region = [c for c in all_contours if is_point_in_region(get_contour_center(c), region_coords_for_check)]\n","        if not contours_in_region:\n","            print(f\"No bubbles found in region: {region_name}\")\n","            continue\n","\n","        # Map the found contours to their grid positions (row, col) within the region\n","        mapped_contours = map_contours_to_grid(contours_in_region, region)\n","\n","        # Extract only the contour objects for classification\n","        classified_contours_only = [mc['contour'] for mc in mapped_contours]\n","        # Classify which bubbles are filled\n","        classified_results = classify_bubbles(thresh, classified_contours_only)\n","\n","        region_data = {} # Stores intermediate decoded data for the current region\n","\n","        # Safety check: Ensure mapped contours and classification results match\n","        if len(mapped_contours) != len(classified_results):\n","            print(f\"Warning: Mismatch in lengths of mapped_contours ({len(mapped_contours)}) and classified_results ({len(classified_results)}) for region {region_name}. Skipping this region.\")\n","            continue\n","\n","        # Iterate through mapped contours to generate labels and populate region_data\n","        for i, mapped_contour in enumerate(mapped_contours):\n","            contour_obj = mapped_contour['contour']\n","            is_filled = classified_results[i][1] # Get the filled status from classification\n","            row, col = mapped_contour['row'], mapped_contour['col']\n","\n","            label_prefix = f\"{region_name}_R{row}_C{col}\" # Default label prefix\n","\n","            if region_type == 'student_id':\n","                if col \u003c grid['cols'] and row \u003c len(row_labels):\n","                    label_prefix = f\"{region_name}_D{col+1}_{row_labels[row]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"digit_{col+1}\", []).append(row_labels[row])\n","\n","            elif region_type == 'true_false':\n","                question_num = row + 1 # True/False questions are usually numbered starting from 1\n","                if col \u003c len(col_labels):\n","                    label_prefix = f\"{region_name}_Q{question_num}_{col_labels[col]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"question_{question_num}\", []).append(col_labels[col])\n","\n","            elif region_type == 'multiple_choice':\n","                question_num = question_offset + row + 1 # Apply offset for question numbering\n","                if col \u003c len(col_labels):\n","                    label_prefix = f\"{region_name}_{question_num}{col_labels[col]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"question_{question_num}\", []).append(col_labels[col])\n","\n","            # Logic for numerical_questions and numerical_questions_(decimal) types\n","            elif region_type == 'numerical_questions' or region_type == 'numerical_questions_(decimal)':\n","                question_num = question_offset + 1\n","                # Here, 'col' represents the digit position, and 'row' maps to the label (digit/symbol)\n","                if row \u003c len(row_labels):\n","                    # Original label based on row_labels\n","                    label_to_append = row_labels[row]\n","\n","                    intended_neg_sign_label = row_labels[-1] if len(row_labels) \u003e 0 else None\n","\n","                    # Special condition for the first column of numerical_questions_(decimal)\n","                    if region_type == 'numerical_questions_(decimal)' and col == 0:\n","                        # Check if '-' is the last label\n","                        if row_labels[row+1] == intended_neg_sign_label:\n","                            label_to_append = '-'\n","\n","                    label_prefix = f\"{region_name}_Pos{col+1}_Q_{question_num}({label_to_append})\"\n","\n","                    if is_filled:\n","                        region_data.setdefault(f\"question_{question_num}\", {})\n","                        region_data[f\"question_{question_num}\"].setdefault(f\"digit_{col+1}\", []).append(label_to_append)\n","\n","            elif region_type == 'custom':\n","                if grid['cols'] \u003e 1 and row \u003c len(row_labels) and all(str(l).isdigit() for l in row_labels):\n","                    # Custom type acting like a numerical digit entry\n","                    label_prefix = f\"{region_name}_D{col+1}_{row_labels[row]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"digit_{col+1}\", []).append(row_labels[row])\n","                elif grid['cols'] == 1 and row \u003c len(row_labels):\n","                    # Custom type with single column, row labels act as field names\n","                    label_prefix = f\"{region_name}_{row_labels[row]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"field_{row_labels[row]}\", []).append(row_labels[row])\n","                elif row \u003c len(row_labels) and col \u003c len(col_labels):\n","                    # Custom type with both row and column labels\n","                    label_prefix = f\"{region_name}_R{row_labels[row]}_C{col_labels[col]}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"field_R{row_labels[row]}\", []).append(col_labels[col])\n","                else:\n","                    # Fallback for custom type: generic position-based label\n","                    label_prefix = f\"{region_name}_Pos{col+1}x{row+1}\"\n","                    if is_filled:\n","                        region_data.setdefault(f\"field_R{row+1}\", []).append(f\"C{col+1}\")\n","\n","            # Append the labeled contour information\n","            labeled_contours.append({\n","                'contour': contour_obj,\n","                'label': label_prefix,\n","                'is_filled': is_filled,\n","                'region': region_name,\n","                'center': mapped_contour['center']\n","            })\n","\n","        if region_type == 'student_id':\n","            decoded_id = []\n","            for i in range(grid['cols']):\n","                digit_values = region_data.get(f\"digit_{i+1}\", [])\n","                if len(digit_values) == 1:\n","                    decoded_id.append(digit_values[0])\n","                elif len(digit_values) \u003e 1:\n","                    decoded_id.append('X') # Mark 'X' for multiple filled bubbles\n","                    print(f\"Warning: Multiple bubbles filled for {region_name} digit {i+1}. Marked as 'X'.\")\n","                else:\n","                    decoded_id.append('') # Mark '' for no filled bubble\n","            results[region_name.lower().replace(' ', '_')] = {\"region_type\": region_type, \"decoded_data\": ''.join(str(d) for d in decoded_id)}\n","\n","        elif region_type == 'custom' and grid['cols'] \u003e 1 and all(str(l).isdigit() for l in row_labels):\n","            decoded_id = []\n","            for i in range(grid['cols']):\n","                digit_values = region_data.get(f\"digit_{i+1}\", [])\n","                if len(digit_values) == 1:\n","                    decoded_id.append(digit_values[0])\n","                elif len(digit_values) \u003e 1:\n","                    decoded_id.append('X') # Mark 'X' for multiple filled bubbles\n","                    print(f\"Warning: Multiple bubbles filled for {region_name} digit {i+1}. Marked as 'X'.\")\n","                else:\n","                    decoded_id.append('_') # Mark '_' for no filled bubble\n","            results[region_name.lower().replace(' ', '_')] = {\"region_type\": region_type, \"decoded_data\": ''.join(str(d) for d in decoded_id)}\n","\n","        elif region_type in ['true_false', 'multiple_choice']:\n","            decoded_answers = {}\n","            start_q = question_offset + 1 if region_type == 'multiple_choice' else 1\n","            for i in range(grid['rows']):\n","                q_num = start_q + i\n","                answers_for_q = region_data.get(f\"question_{q_num}\", [])\n","                if len(answers_for_q) == 1:\n","                    decoded_answers[str(q_num)] = answers_for_q[0]\n","                elif len(answers_for_q) \u003e 1:\n","                    decoded_answers[str(q_num)] = 'X' # Mark 'X' for multiple selections\n","                    print(f\"Warning: Multiple bubbles filled for {region_name} question {q_num}. Marked as 'X'.\")\n","                else:\n","                    decoded_answers[str(q_num)] = None # Mark None for no selection\n","            results[region_name.lower().replace(' ', '_')] = {\"region_type\": region_type, \"decoded_data\": decoded_answers}\n","\n","        # Decoding logic for numerical_questions and numerical_questions_(decimal)\n","        elif region_type == 'numerical_questions' or region_type == 'numerical_questions_(decimal)':\n","            # Assume one single numerical answer per region for this output format\n","            start_q = question_offset + 1\n","            question_digits_data = region_data.get(f\"question_{start_q}\", {})\n","            decoded_number_parts = []\n","\n","            first_col_values = question_digits_data.get(\"digit_1\", [])\n","            if '-' in first_col_values: # Check if '-' was marked in the first column\n","                if len(first_col_values) \u003e 1:\n","                    # This case implies multiple bubbles were filled in the first column,\n","                    # one of which was '-'. This should ideally not happen if only '-' is an option.\n","                    # For safety, we still mark it ambiguous.\n","                    print(f\"Warning: Multiple bubbles filled in the first position for {region_name} question {start_q}, including '-'. Marking as 'X'.\")\n","                    decoded_number_parts.append('X')\n","                else:\n","                    # Exactly '-' was marked\n","                    decoded_number_parts.append('-')\n","            elif len(first_col_values) \u003e 0:\n","                 # This branch means something *other* than '-' was marked in the first column,\n","                 # which contradicts \"The first column contains only -\".\n","                 # If the template truly enforces only '-' here, this is an error in input data.\n","                 # For robustness, we'll mark it as ambiguous if anything else is there.\n","                print(f\"Warning: Unexpected bubble(s) marked in the first position for {region_name} question {start_q}. Expected only '-', but found {first_col_values}. Marking as 'X'.\")\n","                decoded_number_parts.append('X')\n","            else:\n","                # No bubble marked in the first column (neither '-' nor anything else)\n","                # In this specific scenario, we print nothing (empty string) to indicate\n","                # absence of the negative sign.\n","                decoded_number_parts.append('')\n","\n","            # Process the remaining columns for digits/symbols\n","            for col_idx in range(1, grid['cols']): # Start from the second column\n","                digit_values = question_digits_data.get(f\"digit_{col_idx+1}\", [])\n","\n","                if len(digit_values) == 1:\n","                    decoded_number_parts.append(str(digit_values[0]))\n","                elif len(digit_values) \u003e 1:\n","                    print(digit_values)\n","                    decoded_number_parts.append('X') # Mark as ambiguous for multiple fills\n","                    print(f\"Warning: Multiple bubbles filled for {region_name} question {start_q}, digit position {col_idx}. Marked as 'X'.\")\n","                else:\n","                    decoded_number_parts.append('_') # Mark as unfilled\n","\n","            # Join all parts to form the raw decoded number string\n","            decoded_number_str = \"\".join(decoded_number_parts)\n","\n","            # Apply decimal point logic only for 'numerical_questions_(decimal)'\n","            if region_type == 'numerical_questions_(decimal)':\n","                temp_str_for_decimal = decoded_number_str\n","                actual_digits_start_index = 0\n","\n","                # Check if the string starts with a negative sign\n","                # Note: `temp_str_for_decimal` now could potentially start with an empty string\n","                # if '-' wasn't bubbled. We need to handle this.\n","                if decoded_number_str.startswith('-'):\n","                    actual_digits_start_index = 1\n","                    temp_str_for_decimal = decoded_number_str[1:] # Process only the digits part\n","                elif decoded_number_str.startswith('X') or decoded_number_str.startswith('_'):\n","                     # If the first 'digit' is an ambiguity or underscore (shouldn't happen for first column now, but for safety)\n","                     # Treat as no leading sign for decimal placement\n","                    actual_digits_start_index = 0 # No leading sign to skip\n","                    temp_str_for_decimal = decoded_number_str # Use the whole string for decimal checks\n","                elif not decoded_number_str: # If the first spot was empty, then temp_str_for_decimal might be empty initially\n","                    temp_str_for_decimal = '' # Ensure it's an empty string for the check\n","                    actual_digits_start_index = 0\n","                else:\n","                    actual_digits_start_index = 0\n","\n","\n","                # Insert decimal only if no ambiguity and enough characters for index -2\n","                if '_' not in temp_str_for_decimal and 'X' not in temp_str_for_decimal and temp_str_for_decimal: # Added `and temp_str_for_decimal`\n","                    if len(temp_str_for_decimal) \u003e= 2: # At least two digits needed for decimal at index -2\n","                        # Calculate insertion point relative to the original string (including potential '-')\n","                        insertion_point = actual_digits_start_index + len(temp_str_for_decimal) - 2\n","                        decoded_number_str = decoded_number_str[:insertion_point] + '.' + \\\n","                                             decoded_number_str[insertion_point:]\n","                    # If less than 2 digits, no decimal is added (e.g., \"1\" remains \"1\", \"0\" remains \"0\")\n","\n","            # The final result for these types is the processed string\n","            final_decoded_value = decoded_number_str\n","\n","            # Replace all underscores with None if no other characters are present\n","            if all(c == '_' for c in final_decoded_value) or not final_decoded_value.strip('-.'):\n","                final_decoded_value = None\n","\n","            # Store the result using a cleaned region name as the key\n","            results[region_name.lower().replace(' ', '_')] = {\"region_type\": region_type, \"decoded_data\": {str(start_q):final_decoded_value}}\n","\n","        elif region_type == 'custom':\n","            # For custom regions, return the raw region_data dictionary\n","            results[region_name.lower().replace(' ', '_')] = {\"region_type\": region_type, \"decoded_data\": list(region_data.values())}\n","\n","    return labeled_contours, results\n","\n","\n","def draw_labeled_results(original, labeled_contours):\n","    output_image = original.copy()\n","    for item in labeled_contours:\n","        contour = item['contour']\n","        label = item['label']\n","        is_filled = item['is_filled']\n","        center = item['center']\n","\n","        color = (0, 255, 0) if is_filled else (0, 0, 255)\n","\n","        cv2.drawContours(output_image, [contour], -1, color, 2)\n","\n","        cv2.circle(output_image, center, 3, color, -1)\n","\n","        display_label = label.split('_')[-1]\n","        cv2.putText(output_image, display_label, (center[0] + 7, center[1] - 15),\n","                    cv2.FONT_HERSHEY_SIMPLEX, 0.4, color, 1)\n","    return output_image\n","\n","\n","def process_omr_with_template(deskewed_img, template_path):\n","    template = load_template(template_path)\n","    if not template:\n","        return None\n","    if deskewed_img is None:\n","        return {\"error\": \"Kindly check uploaded image, Make sure its clear and Markers are visible\"}\n","    original, thresh = preprocess_image(deskewed_img)\n","\n","    template_markers_json = template['metadata']['marker_positions']\n","    template_tl = [template_markers_json['top_left']['x'], template_markers_json['top_left']['y']]\n","    template_tr = [template_markers_json['top_right']['x'], template_markers_json['top_right']['y']]\n","    template_br = [template_markers_json['bottom_right']['x'], template_markers_json['bottom_right']['y']]\n","    template_bl = [template_markers_json['bottom_left']['x'], template_markers_json['bottom_left']['y']]\n","\n","    src_template_pts = np.float32([template_tl, template_tr, template_br, template_bl])\n","    src_template_pts = order_points(src_template_pts)\n","\n","    actual_height, actual_width = original.shape[:2]\n","\n","    dst_deskewed_pts = np.float32([\n","        [0, 0],\n","        [actual_width - 1, 0],\n","        [actual_width - 1, actual_height - 1],\n","        [0, actual_height - 1]\n","    ])\n","\n","    M = cv2.getPerspectiveTransform(src_template_pts, dst_deskewed_pts)\n","\n","    for region in template['regions']:\n","        coords = region['coordinates']\n","\n","        region_corners = np.float32([\n","            [coords['x'], coords['y']],\n","            [coords['x'] + coords['width'], coords['y']],\n","            [coords['x'] + coords['width'], coords['y'] + coords['height']],\n","            [coords['x'], coords['y'] + coords['height']]\n","        ]).reshape(-1, 1, 2)\n","\n","        transformed_corners = cv2.perspectiveTransform(region_corners, M).reshape(-1, 2)\n","\n","        region['coordinates']['x'] = int(np.min(transformed_corners[:, 0]))\n","        region['coordinates']['y'] = int(np.min(transformed_corners[:, 1]))\n","        region['coordinates']['width'] = int(np.max(transformed_corners[:, 0]) - region['coordinates']['x'])\n","        region['coordinates']['height'] = int(np.max(transformed_corners[:, 1]) - region['coordinates']['y'])\n","\n","    bubbles = find_bubble_contours(thresh)\n","    print(f\"Found {len(bubbles)} potential bubbles after dynamic filtering.\")\n","\n","    labeled_contours, decoded_data = generate_labels_and_decode(template, bubbles, thresh)\n","\n","    output_image = draw_labeled_results(original.copy(), labeled_contours)\n","    return output_image, decoded_data\n","\n","def decode_omr(input_omr, omr_template, thresh_size, aspect_ratio_tolerance, check_orientation):\n","    deskewed_document = deskew_document(input_omr, thresh_size, aspect_ratio_tolerance, check_orientation)\n","\n","    if deskewed_document is not None:\n","        output_image, decoded_data = process_omr_with_template(deskewed_document, omr_template)\n","\n","        if decoded_data:\n","            return output_image, decoded_data\n","        else:\n","            return None, None\n","    else:\n","        return None, None\n","\n","\n","def grade_omr_sheet(solution_json, answer_json, question_limits, omr_template, if_correct=4, if_wrong=-1):\n","    results = {\n","        'student_info': {},\n","        'section_wise_marks': {},\n","        'question_wise_analysis': {},\n","        'total_marks': 0,\n","        'total_questions': 0,\n","        'correct_answers': 0,\n","        'wrong_answers': 0,\n","        'unattempted': 0,\n","        'multiple_marked': 0,\n","        'summary': {}\n","    }\n","    with open(omr_template, 'r') as f:\n","        template = json.load(f)\n","\n","    if question_limits == {}:\n","        question_limits = get_template_limits(template)\n","\n","    # Store sections in order for adjacent checking\n","    section_order = []\n","    section_question_ranges = {}\n","    section_name_map = {}\n","    questions_processed_per_key = {key:0 for key in question_limits.keys()}\n","\n","    for region in template[\"regions\"]:\n","        subject = region[\"name\"].replace(\" \", \"_\").replace(\"-\", \"_\").split(\"_\")[0]\n","        region_name = region[\"name\"].lower().replace(\" \", \"_\")\n","        if region[\"type\"] == \"multiple_choice\":\n","            section_name_map[region_name] = f\"{subject}_MCQ\"\n","        if region[\"type\"] == \"true_false\":\n","            section_name_map[region_name] = f\"{subject}_T/F\"\n","        elif region[\"type\"] in [\"numerical_questions\", \"numerical_questions_(decimal)\"]:\n","            section_name_map[region_name] = f\"{subject}_Numerical\"\n","\n","    for section_name, section_data in answer_json.items():\n","        if isinstance(section_data[\"decoded_data\"], str):\n","            if 'student' in section_name.lower() or 'id' in section_name.lower() or 'roll' in section_name.lower():\n","                results['student_info'][\"roll_number\"] = section_data[\"decoded_data\"]\n","            else:\n","                results['custom_fields'] = {}\n","                results['custom_fields'][section_name] = section_data[\"decoded_data\"]\n","            continue\n","\n","        elif section_data[\"region_type\"] == \"custom\":\n","                results['custom_fields'] = {}\n","                results['custom_fields'][section_name] = section_data[\"decoded_data\"]\n","\n","        else:\n","            section_order.append(section_name)\n","\n","            section_results = {\n","                'marks': 0,\n","                'total_questions': 0,\n","                'correct': 0,\n","                'wrong': 0,\n","                'unattempted': 0,\n","                'multiple_marked': 0,\n","                'questions': {}\n","            }\n","\n","            solution_section = solution_json.get(section_name, {})\n","\n","            # Store question range for this section\n","            question_nums = [int(q) for q in section_data[\"decoded_data\"].keys()]\n","            section_question_ranges[section_name] = {\n","                'min': min(question_nums),\n","                'max': max(question_nums),\n","                'nums': sorted(question_nums)\n","            }\n","\n","            limit_key = section_name_map.get(section_name, section_name)\n","            limit = question_limits.get(limit_key) if isinstance(question_limits, dict) else None\n","\n","            for question_num, student_answer in section_data[\"decoded_data\"].items():\n","                if limit is not None and questions_processed_per_key[limit_key] \u003e= limit:\n","                    print(f\"Limit reached for {limit_key}: {limit} questions processed.\")\n","                    break\n","\n","                correct_answer = solution_section[\"decoded_data\"].get(question_num)\n","\n","                question_key = f\"{section_name.replace('_', ' ').title()}  Q-{question_num}\"\n","                question_result = {\n","                    'student_answer': student_answer,\n","                    'correct_answer': correct_answer,\n","                    'marks': 0,\n","                    'status': 'unattempted'\n","                }\n","\n","                section_results['total_questions'] += 1\n","\n","                if student_answer == 'X':\n","                    question_result['marks'] = if_wrong\n","                    question_result['status'] = 'multiple_marked'\n","                    section_results['multiple_marked'] += 1\n","                    section_results['marks'] += if_wrong\n","\n","                elif student_answer is None:\n","                    question_result['marks'] = 0\n","                    question_result['status'] = 'unattempted'\n","                    section_results['unattempted'] += 1\n","\n","                elif student_answer == correct_answer:\n","                    question_result['marks'] = if_correct\n","                    question_result['status'] = 'correct'\n","                    section_results['correct'] += 1\n","                    section_results['marks'] += if_correct\n","\n","                else:\n","                    question_result['marks'] = if_wrong\n","                    question_result['status'] = 'wrong'\n","                    section_results['wrong'] += 1\n","                    section_results['marks'] += if_wrong\n","\n","                section_results['questions'][question_key] = question_result\n","                results['question_wise_analysis'][question_key] = question_result\n","                questions_processed_per_key[limit_key] += 1\n","\n","            results['section_wise_marks'][section_name] = section_results\n","\n","    # Safe section combination with dynamic updates\n","    changed = True\n","    while changed:\n","        changed = False\n","        section_names = list(results['section_wise_marks'].keys())\n","\n","        for i in range(len(section_names) - 1):\n","            current_section = section_names[i]\n","            next_section = section_names[i + 1]\n","\n","            # Check if both sections exist and can be combined\n","            if (current_section in results['section_wise_marks'] and\n","                next_section in results['section_wise_marks'] and\n","                can_combine_sections(current_section, next_section, section_question_ranges)):\n","\n","                # Combine next section into current section\n","                current_data = results['section_wise_marks'][current_section]\n","                next_data = results['section_wise_marks'][next_section]\n","                new_min = min(section_question_ranges[current_section]['min'], section_question_ranges[next_section]['min'])\n","                new_max = max(section_question_ranges[current_section]['max'], section_question_ranges[next_section]['max'])\n","                new_nums = section_question_ranges[current_section]['nums'] + section_question_ranges[next_section]['nums']\n","\n","                # Merge all data\n","                current_data['marks'] += next_data['marks']\n","                current_data['total_questions'] += next_data['total_questions']\n","                current_data['correct'] += next_data['correct']\n","                current_data['wrong'] += next_data['wrong']\n","                current_data['unattempted'] += next_data['unattempted']\n","                current_data['multiple_marked'] += next_data['multiple_marked']\n","                current_data['questions'].update(next_data['questions'])\n","\n","                # Remove the merged section\n","                del results['section_wise_marks'][next_section]\n","\n","                new_name = current_section.replace(\"-\",\"\").split(\"_\")[0]\n","                new_d = {}\n","                for k, v in results['section_wise_marks'].items():\n","                    if k == current_section:\n","                        new_d[new_name] = v\n","                    else:\n","                        new_d[k] = v\n","                results['section_wise_marks'] = new_d\n","\n","                section_question_ranges[new_name] = section_question_ranges[current_section]\n","                del section_question_ranges[current_section]\n","\n","                section_question_ranges[new_name] = {\n","                    'min': new_min,\n","                    'max': new_max,\n","                    'nums': new_nums\n","                }\n","                # Mark that we made a change and break to restart\n","                changed = True\n","                break\n","\n","    # Calculate totals\n","    for section_data in results['section_wise_marks'].values():\n","        results['total_marks'] += section_data['marks']\n","        results['total_questions'] += section_data['total_questions']\n","        results['correct_answers'] += section_data['correct']\n","        results['wrong_answers'] += section_data['wrong']\n","        results['unattempted'] += section_data['unattempted']\n","        results['multiple_marked'] += section_data['multiple_marked']\n","\n","    # Calculate summary statistics\n","    total_q = results['total_questions']\n","    if total_q \u003e 0:\n","        results['summary'] = {\n","            'accuracy_percentage': round((results['correct_answers'] / total_q) * 100, 2),\n","            'attempted_percentage': round(((total_q - results['unattempted']) / total_q) * 100, 2),\n","            'maximum_possible_marks': total_q * if_correct,\n","            'minimum_possible_marks': total_q * if_wrong,\n","            'marks_percentage': round((results['total_marks'] / (total_q * if_correct)) * 100, 2) if total_q * if_correct \u003e 0 else 0\n","        }\n","\n","    return results\n","\n","\n","def can_combine_sections(current_section, next_section, section_question_ranges):\n","    current_range = section_question_ranges[current_section]\n","    next_range = section_question_ranges[next_section]\n","\n","    is_continuous = (current_range['max'] + 1 == next_range['min'])  # 30 + 1 == 31 ✓\n","\n","    base_current = current_section.lower().replace(\"-\",\"\").split(\"_\")[0]\n","    base_next = next_section.lower().replace(\"-\",\"\").split(\"_\")[0]\n","\n","    return is_continuous and (base_current == base_next)\n","\n","# def get_results_markdown(results):\n","#     md_lines = []\n","\n","#     # Header\n","#     md_lines.append(\"# OMR ANSWER SHEET GRADING RESULTS\")\n","#     md_lines.append(\"=\" * 80)\n","#     md_lines.append(\"\")\n","\n","#     # Student Information\n","#     if results['student_info']:\n","#         md_lines.append(\"## 📋 Student Information\")\n","#         md_lines.append(\"\")\n","#         for key, value in results['student_info'].items():\n","#             md_lines.append(f\"- **{key.replace('_', ' ').title()}:** {value}\")\n","#         md_lines.append(\"\")\n","\n","#     # Custom Fields\n","#     if results['custom_fields']:\n","#         md_lines.append(\"## 📝 Custom Fields\")\n","#         md_lines.append(\"\")\n","#         for key, value in results['custom_fields'].items():\n","#             if isinstance(value, dict):\n","#                 md_lines.append(f\"- **{key.replace('_', ' ').title()}:**\")\n","#                 for sub_key, sub_value in value.items():\n","#                     clean_key = sub_key.replace('field_', '').replace('_', ' ').title()\n","#                     md_lines.append(f\"  - {clean_key}: {sub_value}\")\n","#             else:\n","#                 md_lines.append(f\"- **{key.replace('_', ' ').title()}:** {value}\")\n","#         md_lines.append(\"\")\n","\n","#     # Overall Performance\n","#     md_lines.append(\"## 🎯 Overall Performance\")\n","#     md_lines.append(\"\")\n","#     md_lines.append(f\"- **Total Questions:** {results['total_questions']}\")\n","#     md_lines.append(f\"- **Total Marks:** {results['total_marks']}\")\n","#     md_lines.append(f\"- **Correct Answers:** {results['correct_answers']}\")\n","#     md_lines.append(f\"- **Wrong Answers:** {results['wrong_answers']}\")\n","#     md_lines.append(f\"- **Unattempted:** {results['unattempted']}\")\n","#     md_lines.append(f\"- **Multiple Marked:** {results['multiple_marked']}\")\n","#     md_lines.append(\"\")\n","\n","#     # Statistics\n","#     if results['summary']:\n","#         summary = results['summary']\n","#         md_lines.append(\"### 📊 Statistics\")\n","#         md_lines.append(\"\")\n","#         md_lines.append(f\"- **Accuracy:** {summary['accuracy_percentage']}%\")\n","#         md_lines.append(f\"- **Attempted:** {summary['attempted_percentage']}%\")\n","#         md_lines.append(f\"- **Score:** {summary['marks_percentage']}%\")\n","#         md_lines.append(f\"- **Max Possible:** {summary['maximum_possible_marks']}\")\n","#         md_lines.append(f\"- **Min Possible:** {summary['minimum_possible_marks']}\")\n","#         md_lines.append(\"\")\n","\n","#     # Section-wise Breakdown\n","#     md_lines.append(\"## 📚 Section-wise Breakdown\")\n","#     md_lines.append(\"\")\n","#     for section_name, section_data in results['section_wise_marks'].items():\n","#         md_lines.append(f\"### 🔹 {section_name.replace('_', ' ').title()}\")\n","#         md_lines.append(\"\")\n","#         md_lines.append(f\"- **Questions:** {section_data['total_questions']}\")\n","#         md_lines.append(f\"- **Marks:** {section_data['marks']}\")\n","#         md_lines.append(f\"- **✓ Correct:** {section_data['correct']}\")\n","#         md_lines.append(f\"- **✗ Wrong:** {section_data['wrong']}\")\n","#         md_lines.append(f\"- **○ Unattempted:** {section_data['unattempted']}\")\n","#         md_lines.append(f\"- **⚠ Multiple:** {section_data['multiple_marked']}\")\n","#         md_lines.append(\"\")\n","\n","#     # Question-wise Analysis\n","#     md_lines.append(\"## 🔍 Question-wise Analysis\")\n","#     md_lines.append(\"\")\n","\n","#     for q_key, q_data in results['question_wise_analysis'].items():\n","#         status_icon = {\n","#             'correct': '✓',\n","#             'wrong': '✗',\n","#             'unattempted': '○',\n","#             'multiple_marked': '⚠'\n","#         }.get(q_data['status'], '?')\n","\n","#         md_lines.append(f\"- {status_icon} **{q_key}:** {q_data['student_answer']} \"\n","#                        f\"(Correct: {q_data['correct_answer']}) = **{q_data['marks']} marks**\")\n","\n","#     return \"\\n\".join(md_lines)\n","\n","def convert_solutions_json(decoded_data, backend_path, question_limit):\n","    limits = copy.deepcopy(question_limit)\n","    with open(backend_path, 'r') as f:\n","        data = json.load(f)\n","\n","    # Create a deep copy to avoid modifying the original\n","    decoded_copy = copy.deepcopy(decoded_data)\n","\n","    answers = [\n","        (question[\"questionIndex\"], question[\"correctOption\"])\n","        for subject in data[\"subjects\"]\n","        for chapter in subject[\"chapters\"]\n","        for question in chapter[\"questions\"]\n","    ]\n","    answers = [data for _, data in sorted(answers, key = lambda x:x[0])]\n","\n","    # Flatten decoded_data question keys in section \u0026 question number order\n","    question_locations = []\n","    for section in decoded_copy:\n","        if isinstance(decoded_copy[section][\"decoded_data\"], dict):\n","            for qno in decoded_copy[section][\"decoded_data\"]:\n","                question_locations.append((section, qno))\n","\n","    i = 0\n","    for section, qno in question_locations:\n","        region_type = decoded_copy[section][\"region_type\"]\n","        key = None\n","        if region_type == \"multiple_choice\":\n","            key = f\"{section.split('_')[0].capitalize()}_MCQ\"\n","        elif region_type == \"true_false\":\n","            key = f\"{section.split('_')[0].capitalize()}_T/F\"\n","        elif region_type in [\"numerical_questions\", \"numerical_questions_(decimal)\"]:\n","            key = f\"{section.split('_')[0].capitalize()}_Numerical\"\n","        else:\n","            continue\n","        if key is not None and limits.get(key, 0) \u003e 0 and i \u003c len(answers):\n","            decoded_copy[section][\"decoded_data\"][qno] = answers[i]\n","            limits[key] -= 1\n","            i += 1\n","        else:\n","            decoded_copy[section][\"decoded_data\"][qno] = None\n","\n","    return decoded_copy\n","\n","def get_template_limits(data):\n","    subjects = defaultdict(lambda: defaultdict(list))\n","\n","    for region in data[\"regions\"]:\n","        subject = region[\"name\"].replace(\" \", \"_\").replace(\"-\", \"_\").split(\"_\")[0]\n","        if region[\"type\"] == \"multiple_choice\":\n","            subjects[subject][\"MCQ\"].append(region)\n","        if region[\"type\"] == \"true_false\":\n","            subjects[subject][\"T/F\"].append(region)\n","        elif region[\"type\"] in [\"numerical_questions\", \"numerical_questions_(decimal)\"]:\n","            subjects[subject][\"Numerical\"].append(region)\n","\n","    limits = {}\n","    for subject in subjects:\n","        total = 0\n","        for type in subjects[subject]:\n","            key = f\"{subject}_{type}\"\n","            if type in [\"MCQ\", \"T/F\"]:\n","                for region in subjects[subject][type]:\n","                    total += region[\"grid\"][\"rows\"]\n","            elif type == \"Numerical\":\n","                total = len(subjects[subject][type])\n","            limits[key] = total\n","    return limits\n","\n","def compute_chapter_wise_analysis(results_json, solutions_path):\n","    with open(solutions_path) as f:\n","        data = json.load(f)\n","\n","    question_order = [\n","        int(question[\"questionIndex\"])-1\n","        for subject in data[\"subjects\"]\n","        for chapter in subject[\"chapters\"]\n","        for question in chapter[\"questions\"]\n","    ]\n","    question_wise = [{key: value} for key, value in results_json[\"question_wise_analysis\"].items()]\n","    question_wise = [question_wise[i] for i in question_order]\n","\n","    chapter_wise = {\n","        subject[\"subjectName\"]: {\n","          chapter[\"chapterName\"]: len(chapter[\"questions\"])\n","          for chapter in subject[\"chapters\"]\n","        }\n","        for subject in data[\"subjects\"]\n","        }\n","\n","    i = 0\n","    for subject in chapter_wise:\n","        for chapter in chapter_wise[subject]:\n","            i_new = i + chapter_wise[subject][chapter]\n","            curr_chapter = {\n","                \"marks\": 0,\n","                \"total_questions\": 0,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 0,\n","                \"multiple_marked\": 0,\n","                \"questions\": {}\n","            }\n","            for question in question_wise[i:i_new]:\n","                key, value = list(question.items())[0]\n","\n","                curr_chapter[\"marks\"] += value[\"marks\"]\n","                curr_chapter[\"total_questions\"] += 1\n","                status = value[\"status\"]\n","                if status == \"correct\":\n","                    curr_chapter[\"correct\"] += 1\n","                elif status == \"wrong\":\n","                    curr_chapter[\"wrong\"] += 1\n","                elif status == \"unattempted\":\n","                    curr_chapter[\"unattempted\"] += 1\n","                elif status == \"multiple_marked\":\n","                    curr_chapter[\"multiple_marked\"] += 1\n","                curr_chapter[\"questions\"][key] = value\n","            chapter_wise[subject][chapter] = curr_chapter\n","            i = i_new\n","\n","    results_json[\"chapter_wise_analysis\"] = chapter_wise\n","    return results_json\n","\n","def check_answers(input_omr_path, solutions_path, omr_template_path, question_limit, if_correct=4, if_wrong=-1,\n","                  thresh_size=201, aspect_ratio_tolerance=1,\n","                  check_orientation=True):\n","    answer_sheet, answers = decode_omr(input_omr_path, omr_template_path,\n","                                       thresh_size, aspect_ratio_tolerance,\n","                                       check_orientation)\n","\n","    solutions = convert_solutions_json(answers, solutions_path, question_limit)\n","\n","    if answer_sheet is None and answers is None:\n","        return \"Please ensure the uploaded image is clear and the markers are clearly visible\"\n","\n","    cv2_imshow(\"answer sheet\", answer_sheet)\n","    # response = input(\"Is the answer sheet properly detected? (y/n)\")\n","    response = 'y'\n","    if response.lower() in ['n', 'no', 'nope']:\n","        return {\"info\" : \"Please ensure the uploaded image is clear and the markers are clearly visible\"}\n","    elif response.lower() in ['y', 'yes', 'yeah']:\n","        results = grade_omr_sheet(solutions, answers, question_limit, omr_template_path, if_correct, if_wrong)\n","\n","        marks = {\"total_marks\": results[\"total_marks\"]}\n","        for section, info in results[\"section_wise_marks\"].items():\n","            marks[section] = info[\"marks\"]\n","\n","        # Generate lines to print\n","        text_lines = [f\"Roll No: {results['student_info']['roll_number']}\"]\n","\n","        # Append section-wise marks\n","        for key, val in marks.items():\n","            if key != \"total_marks\" and key != \"Roll No\":\n","                text_lines.append(f\"{key.capitalize()}: {val}\")\n","        text_lines.append(f\"Total Marks: {marks['total_marks']}\")\n","\n","        font = cv2.FONT_HERSHEY_SIMPLEX\n","        font_scale = 1.4\n","        thickness = 5\n","        color_fill = (255, 255, 255)   # White\n","        color_outline = (0, 0, 0)      # Black\n","\n","        x_margin = 150\n","        y_start = 150\n","        line_spacing = 25\n","\n","        img_h, img_w = answer_sheet.shape[:2]\n","        for i, line in enumerate(text_lines):\n","            (text_w, text_h), _ = cv2.getTextSize(line, font, font_scale, thickness)\n","            x = img_w - text_w - x_margin\n","            y = y_start + i * (text_h + line_spacing)\n","            cv2.putText(answer_sheet, line, (x, y), font, font_scale, color_outline, thickness + 8, lineType=cv2.LINE_AA)\n","            cv2.putText(answer_sheet, line, (x, y), font, font_scale, color_fill, thickness, lineType=cv2.LINE_AA)\n","        return answer_sheet, compute_chapter_wise_analysis(results, solutions_path)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":297},"executionInfo":{"elapsed":49,"status":"error","timestamp":1758120020723,"user":{"displayName":"Taanush abraham","userId":"16497560746847074205"},"user_tz":-330},"id":"0pg3d6J4WFy6","outputId":"57059409-d0db-41fa-faf0-afef24a827dd"},"outputs":[{"ename":"FileNotFoundError","evalue":"[Errno 2] No such file or directory: 'JEE_MCQ_template.json'","output_type":"error","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mFileNotFoundError\u001b[0m                         Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-3988951183.py\u001b[0m in \u001b[0;36m\u003ccell line: 0\u003e\u001b[0;34m()\u001b[0m\n\u001b[1;32m     30\u001b[0m     \u001b[0;32mreturn\u001b[0m \u001b[0mlimits\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     31\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---\u003e 32\u001b[0;31m \u001b[0mget_template_limits\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"JEE_MCQ_template.json\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m","\u001b[0;32m/tmp/ipython-input-3988951183.py\u001b[0m in \u001b[0;36mget_template_limits\u001b[0;34m(template_path)\u001b[0m\n\u001b[1;32m      3\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[0;32mdef\u001b[0m \u001b[0mget_template_limits\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mtemplate_path\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----\u003e 5\u001b[0;31m     \u001b[0;32mwith\u001b[0m \u001b[0mopen\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mtemplate_path\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m\"r\"\u001b[0m\u001b[0;34m)\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0mf\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      6\u001b[0m         \u001b[0mdata\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mjson\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mloads\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mf\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mread\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      7\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mFileNotFoundError\u001b[0m: [Errno 2] No such file or directory: 'JEE_MCQ_template.json'"]}],"source":["import json\n","from collections import defaultdict\n","\n","def get_template_limits(template_path):\n","    with open(template_path, \"r\") as f:\n","        data = json.loads(f.read())\n","\n","    subjects = defaultdict(lambda: defaultdict(list))\n","\n","    for region in data[\"regions\"]:\n","        subject = region[\"name\"].replace(\" \", \"_\").replace(\"-\", \"_\").split(\"_\")[0]\n","        if region[\"type\"] == \"multiple_choice\":\n","            subjects[subject][\"MCQ\"].append(region)\n","        if region[\"type\"] == \"true_false\":\n","            subjects[subject][\"T/F\"].append(region)\n","        elif region[\"type\"] in [\"numerical_questions\", \"numerical_questions_(decimal)\"]:\n","            subjects[subject][\"Numerical\"].append(region)\n","\n","    limits = {}\n","    for subject in subjects:\n","        total = 0\n","        for type in subjects[subject]:\n","            key = f\"{subject}_{type}\"\n","            if type in [\"MCQ\", \"T/F\"]:\n","                for region in subjects[subject][type]:\n","                    total += region[\"grid\"][\"rows\"]\n","            elif type == \"Numerical\":\n","                total = len(subjects[subject][type])\n","            limits[key] = total\n","    return limits\n","\n","get_template_limits(\"JEE_MCQ_template.json\")"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true,"base_uri":"https://localhost:8080/","height":0,"output_embedded_package_id":"1Bk5xT-bzVYmbAVMDXohYQT9j9nS2wSvH"},"id":"IeCqeCmTvhbi","outputId":"3fcdaf0c-ef27-4717-8e53-ec9be9e3fc11"},"outputs":[],"source":["if __name__ == \"__main__\":\n","    # input_omr = 'JEE Advanced - 1.jpg'\n","    # omr_template = \"JEE_Adv_1_template.json\"\n","    # limit = {'Maths_MCQ': 8, 'Maths_Numerical': 5, 'Physics_MCQ': 10, 'Physics_Numerical': 6, 'Chemistry_MCQ': 10, 'Chemistry_Numerical': 6}\n","\n","    # input_omr = 'JEE Advanced - 2.jpg'\n","    # omr_template = \"JEE_Adv_2_template.json\"\n","    # limit = {'Maths_MCQ': 5, 'Maths_Numerical': 6, 'Physics_MCQ': 8, 'Physics_Numerical': 8, 'Chemistry_MCQ': 8, 'Chemistry_Numerical': 8}\n","\n","    input_omr = 'OMRT.jpg'\n","    omr_template = \"omr_template.json\"\n","    limit = {'Physics_MCQ': 50, 'Chemistry_MCQ': 50, 'Mathematics_MCQ': 50}\n","\n","    # input_omr = 'JEE_Num3.jpg'\n","    # omr_template = \"JEE_Num_template.json\"\n","    # limit = {'Physics_MCQ': 20, 'Physics_Numerical': 5, 'Chemistry_MCQ': 20, 'Chemistry_Numerical': 5, 'Maths_MCQ': 20, 'Maths_Numerical': 5}\n","\n","    # input_omr = 'NEET0.jpg'\n","    # omr_template = \"NEET_template.json\"\n","    # limit = {'Physics_MCQ': 45, 'Chemistry_MCQ': 45, 'Botany_MCQ': 45, 'Zoology_MCQ': 45}\n","\n","    answer_sheet, results = check_answers(\n","              input_omr_path = input_omr,\n","              omr_template_path = omr_template,\n","              solutions_path = 'backend_150.json',\n","              question_limit = limit,\n","              if_correct=4,\n","              if_wrong=-1,\n","               thresh_size=201,\n","              aspect_ratio_tolerance=1,\n","              check_orientation=True\n","              )\n","\n","    # if not isinstance(results, dict):\n","    #     print(results)\n","    # else:\n","    # cv2_imshow(\"answer sheet\", answer_sheet)\n","    # print(json.dumps(results, indent = 4))"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":5,"status":"ok","timestamp":1757345370034,"user":{"displayName":"Hari Prasath","userId":"09879966335320186461"},"user_tz":-330},"id":"rxb36qCkwBlg","outputId":"086017a0-f561-4da8-b682-3d8c87f045b9"},"outputs":[{"name":"stdout","output_type":"stream","text":["{\n","    \"student_info\": {\n","        \"roll_number\": \"00000000\"\n","    },\n","    \"section_wise_marks\": {\n","        \"physics\": {\n","            \"marks\": -1,\n","            \"total_questions\": 25,\n","            \"correct\": 1,\n","            \"wrong\": 3,\n","            \"unattempted\": 19,\n","            \"multiple_marked\": 2,\n","            \"questions\": {\n","                \"Physics  Q-1\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Physics  Q-2\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-3\": {\n","                    \"student_answer\": \"B\",\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": -1,\n","                    \"status\": \"wrong\"\n","                },\n","                \"Physics  Q-4\": {\n","                    \"student_answer\": \"A\",\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": -1,\n","                    \"status\": \"wrong\"\n","                },\n","                \"Physics  Q-5\": {\n","                    \"student_answer\": \"B\",\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 4,\n","                    \"status\": \"correct\"\n","                },\n","                \"Physics  Q-6\": {\n","                    \"student_answer\": \"C\",\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": -1,\n","                    \"status\": \"wrong\"\n","                },\n","                \"Physics  Q-7\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Physics  Q-8\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-9\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-10\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-11\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-12\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-13\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-14\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-15\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-16\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-17\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-18\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-19\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-20\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-21\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-22\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-23\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-24\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Physics  Q-25\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                }\n","            }\n","        },\n","        \"chemistry\": {\n","            \"marks\": -5,\n","            \"total_questions\": 25,\n","            \"correct\": 0,\n","            \"wrong\": 1,\n","            \"unattempted\": 20,\n","            \"multiple_marked\": 4,\n","            \"questions\": {\n","                \"Chemistry  Q-1\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Chemistry  Q-2\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Chemistry  Q-3\": {\n","                    \"student_answer\": \"A\",\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": -1,\n","                    \"status\": \"wrong\"\n","                },\n","                \"Chemistry  Q-4\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Chemistry  Q-5\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Chemistry  Q-6\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-7\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-8\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-9\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-10\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-11\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-12\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-13\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-14\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-15\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-16\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-17\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-18\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-19\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-20\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-21\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-22\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-23\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-24\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Chemistry  Q-25\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                }\n","            }\n","        },\n","        \"maths\": {\n","            \"marks\": 2,\n","            \"total_questions\": 25,\n","            \"correct\": 1,\n","            \"wrong\": 0,\n","            \"unattempted\": 22,\n","            \"multiple_marked\": 2,\n","            \"questions\": {\n","                \"Maths  Q-1\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Maths  Q-2\": {\n","                    \"student_answer\": \"B\",\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 4,\n","                    \"status\": \"correct\"\n","                },\n","                \"Maths  Q-3\": {\n","                    \"student_answer\": \"X\",\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": -1,\n","                    \"status\": \"multiple_marked\"\n","                },\n","                \"Maths  Q-4\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-5\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-6\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-7\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-8\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-9\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-10\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-11\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-12\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-13\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-14\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-15\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-16\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-17\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-18\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-19\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-20\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-21\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"D\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-22\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-23\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"C\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-24\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"A\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                },\n","                \"Maths  Q-25\": {\n","                    \"student_answer\": null,\n","                    \"correct_answer\": \"B\",\n","                    \"marks\": 0,\n","                    \"status\": \"unattempted\"\n","                }\n","            }\n","        }\n","    },\n","    \"question_wise_analysis\": {\n","        \"Physics  Q-1\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"B\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Physics  Q-2\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-3\": {\n","            \"student_answer\": \"B\",\n","            \"correct_answer\": \"A\",\n","            \"marks\": -1,\n","            \"status\": \"wrong\"\n","        },\n","        \"Physics  Q-4\": {\n","            \"student_answer\": \"A\",\n","            \"correct_answer\": \"C\",\n","            \"marks\": -1,\n","            \"status\": \"wrong\"\n","        },\n","        \"Physics  Q-5\": {\n","            \"student_answer\": \"B\",\n","            \"correct_answer\": \"B\",\n","            \"marks\": 4,\n","            \"status\": \"correct\"\n","        },\n","        \"Physics  Q-6\": {\n","            \"student_answer\": \"C\",\n","            \"correct_answer\": \"A\",\n","            \"marks\": -1,\n","            \"status\": \"wrong\"\n","        },\n","        \"Physics  Q-7\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"D\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Physics  Q-8\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-9\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-10\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-11\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-12\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-13\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-14\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-15\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-16\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-17\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-18\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-19\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-20\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-21\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-22\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-23\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-24\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Physics  Q-25\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-1\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"C\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Chemistry  Q-2\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"A\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Chemistry  Q-3\": {\n","            \"student_answer\": \"A\",\n","            \"correct_answer\": \"D\",\n","            \"marks\": -1,\n","            \"status\": \"wrong\"\n","        },\n","        \"Chemistry  Q-4\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"B\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Chemistry  Q-5\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"A\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Chemistry  Q-6\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-7\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-8\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-9\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-10\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-11\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-12\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-13\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-14\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-15\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-16\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-17\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-18\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-19\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-20\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-21\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-22\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-23\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-24\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Chemistry  Q-25\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-1\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"D\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Maths  Q-2\": {\n","            \"student_answer\": \"B\",\n","            \"correct_answer\": \"B\",\n","            \"marks\": 4,\n","            \"status\": \"correct\"\n","        },\n","        \"Maths  Q-3\": {\n","            \"student_answer\": \"X\",\n","            \"correct_answer\": \"A\",\n","            \"marks\": -1,\n","            \"status\": \"multiple_marked\"\n","        },\n","        \"Maths  Q-4\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-5\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-6\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-7\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-8\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-9\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-10\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-11\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-12\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-13\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-14\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-15\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-16\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-17\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-18\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-19\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-20\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-21\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"D\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-22\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-23\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"C\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-24\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"A\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        },\n","        \"Maths  Q-25\": {\n","            \"student_answer\": null,\n","            \"correct_answer\": \"B\",\n","            \"marks\": 0,\n","            \"status\": \"unattempted\"\n","        }\n","    },\n","    \"total_marks\": -4,\n","    \"total_questions\": 75,\n","    \"correct_answers\": 2,\n","    \"wrong_answers\": 4,\n","    \"unattempted\": 61,\n","    \"multiple_marked\": 8,\n","    \"summary\": {\n","        \"accuracy_percentage\": 2.67,\n","        \"attempted_percentage\": 18.67,\n","        \"maximum_possible_marks\": 300,\n","        \"minimum_possible_marks\": -75,\n","        \"marks_percentage\": -1.33\n","    },\n","    \"chapter_wise_analysis\": {\n","        \"Physics\": {\n","            \"Mechanics\": {\n","                \"marks\": -1,\n","                \"total_questions\": 8,\n","                \"correct\": 1,\n","                \"wrong\": 3,\n","                \"unattempted\": 2,\n","                \"multiple_marked\": 2,\n","                \"questions\": {\n","                    \"Physics  Q-1\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Physics  Q-2\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-3\": {\n","                        \"student_answer\": \"B\",\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": -1,\n","                        \"status\": \"wrong\"\n","                    },\n","                    \"Physics  Q-4\": {\n","                        \"student_answer\": \"A\",\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": -1,\n","                        \"status\": \"wrong\"\n","                    },\n","                    \"Physics  Q-5\": {\n","                        \"student_answer\": \"B\",\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 4,\n","                        \"status\": \"correct\"\n","                    },\n","                    \"Physics  Q-6\": {\n","                        \"student_answer\": \"C\",\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": -1,\n","                        \"status\": \"wrong\"\n","                    },\n","                    \"Physics  Q-7\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Physics  Q-8\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Electromagnetism\": {\n","                \"marks\": 0,\n","                \"total_questions\": 9,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 9,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Physics  Q-9\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-10\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-11\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-12\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-13\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-14\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-15\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-16\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-17\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Modern Physics \u0026 Optics\": {\n","                \"marks\": 0,\n","                \"total_questions\": 8,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 8,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Physics  Q-18\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-19\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-20\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-21\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-22\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-23\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-24\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Physics  Q-25\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            }\n","        },\n","        \"Chemistry\": {\n","            \"Physical Chemistry\": {\n","                \"marks\": -5,\n","                \"total_questions\": 8,\n","                \"correct\": 0,\n","                \"wrong\": 1,\n","                \"unattempted\": 3,\n","                \"multiple_marked\": 4,\n","                \"questions\": {\n","                    \"Chemistry  Q-1\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Chemistry  Q-2\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Chemistry  Q-3\": {\n","                        \"student_answer\": \"A\",\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": -1,\n","                        \"status\": \"wrong\"\n","                    },\n","                    \"Chemistry  Q-4\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Chemistry  Q-5\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Chemistry  Q-6\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-7\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-8\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Inorganic Chemistry\": {\n","                \"marks\": 0,\n","                \"total_questions\": 8,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 8,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Chemistry  Q-9\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-10\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-11\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-12\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-13\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-14\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-15\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-16\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Organic Chemistry\": {\n","                \"marks\": 0,\n","                \"total_questions\": 9,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 9,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Chemistry  Q-17\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-18\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-19\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-20\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-21\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-22\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-23\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-24\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Chemistry  Q-25\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            }\n","        },\n","        \"Mathematics\": {\n","            \"Algebra \u0026 Coordinate Geometry\": {\n","                \"marks\": 2,\n","                \"total_questions\": 10,\n","                \"correct\": 1,\n","                \"wrong\": 0,\n","                \"unattempted\": 7,\n","                \"multiple_marked\": 2,\n","                \"questions\": {\n","                    \"Maths  Q-1\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Maths  Q-2\": {\n","                        \"student_answer\": \"B\",\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 4,\n","                        \"status\": \"correct\"\n","                    },\n","                    \"Maths  Q-3\": {\n","                        \"student_answer\": \"X\",\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": -1,\n","                        \"status\": \"multiple_marked\"\n","                    },\n","                    \"Maths  Q-4\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-5\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-6\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-7\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-8\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-9\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-10\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Calculus\": {\n","                \"marks\": 0,\n","                \"total_questions\": 9,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 9,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Maths  Q-11\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-12\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-13\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-14\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-15\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-16\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-17\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-18\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-19\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            },\n","            \"Vectors \u0026 3D Geometry\": {\n","                \"marks\": 0,\n","                \"total_questions\": 6,\n","                \"correct\": 0,\n","                \"wrong\": 0,\n","                \"unattempted\": 6,\n","                \"multiple_marked\": 0,\n","                \"questions\": {\n","                    \"Maths  Q-20\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-21\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"D\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-22\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-23\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"C\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-24\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"A\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    },\n","                    \"Maths  Q-25\": {\n","                        \"student_answer\": null,\n","                        \"correct_answer\": \"B\",\n","                        \"marks\": 0,\n","                        \"status\": \"unattempted\"\n","                    }\n","                }\n","            }\n","        }\n","    }\n","}\n"]}],"source":["print(json.dumps(results, indent = 4))"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":2551,"status":"ok","timestamp":1753538227481,"user":{"displayName":"Hari Prasath","userId":"09879966335320186461"},"user_tz":-330},"id":"NnQz_5fgKBTY","outputId":"a4895089-7d8a-47db-efc9-56361f617e82"},"outputs":[{"name":"stdout","output_type":"stream","text":["Contour 33: Valid marker candidate found with SAD score 4!\n","Contour 33: Extracted Pattern:\n","[[1 2 1]\n"," [1 0 1]\n"," [1 1 0]]\n","Contour 33: SAD Score = 4. Max tolerance = 4\n","Contour 41: Valid marker candidate found with SAD score 0!\n","Contour 41: Extracted Pattern:\n","[[0 1 0]\n"," [1 0 1]\n"," [0 1 0]]\n","Contour 41: SAD Score = 0. Max tolerance = 4\n","Contour 47: Valid marker candidate found with SAD score 0!\n","Contour 47: Extracted Pattern:\n","[[0 1 0]\n"," [1 0 1]\n"," [0 1 0]]\n","Contour 47: SAD Score = 0. Max tolerance = 4\n","Contour 140: Valid marker candidate found with SAD score 0!\n","Contour 140: Extracted Pattern:\n","[[0 1 0]\n"," [1 0 1]\n"," [0 1 0]]\n","Contour 140: SAD Score = 0. Max tolerance = 4\n","Contour 143: Valid marker candidate found with SAD score 0!\n","Contour 143: Extracted Pattern:\n","[[0 1 0]\n"," [1 0 1]\n"," [0 1 0]]\n","Contour 143: SAD Score = 0. Max tolerance = 4\n","Contour 148: Valid marker candidate found with SAD score 4!\n","Contour 148: Extracted Pattern:\n","[[1 1 1]\n"," [1 0 1]\n"," [1 1 1]]\n","Contour 148: SAD Score = 4. Max tolerance = 4\n","Contour 153: Valid marker candidate found with SAD score 4!\n","Contour 153: Extracted Pattern:\n","[[1 1 1]\n"," [1 0 1]\n"," [1 1 1]]\n","Contour 153: SAD Score = 4. Max tolerance = 4\n","Contour 159: Valid marker candidate found with SAD score 4!\n","Contour 159: Extracted Pattern:\n","[[0 1 1]\n"," [1 0 1]\n"," [1 2 1]]\n","Contour 159: SAD Score = 4. Max tolerance = 4\n","Contour 167: Valid marker candidate found with SAD score 4!\n","Contour 167: Extracted Pattern:\n","[[1 1 0]\n"," [1 0 1]\n"," [1 2 1]]\n","Contour 167: SAD Score = 4. Max tolerance = 4\n","✅ Template loaded: 4 regions found\n","Found 401 potential bubbles after dynamic filtering.\n","         145403 function calls (145134 primitive calls) in 2.548 seconds\n","\n","   Ordered by: cumulative time\n","   List reduced from 187 to 20 due to restriction \u003c20\u003e\n","\n","   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n","        1    0.000    0.000    2.548    2.548 /tmp/ipython-input-2-4171917840.py:1130(check_answers)\n","        1    0.000    0.000    2.540    2.540 /tmp/ipython-input-2-4171917840.py:767(decode_omr)\n","        1    0.004    0.004    2.008    2.008 /tmp/ipython-input-2-4171917840.py:132(deskew_document)\n","        1    0.044    0.044    1.787    1.787 /tmp/ipython-input-2-4171917840.py:22(find_custom_markers)\n","        2    1.568    0.784    1.568    0.784 {adaptiveThreshold}\n","        1    0.001    0.001    0.531    0.531 /tmp/ipython-input-2-4171917840.py:714(process_omr_with_template)\n","        1    0.000    0.000    0.246    0.246 /tmp/ipython-input-2-4171917840.py:216(preprocess_image)\n","        1    0.005    0.005    0.224    0.224 /tmp/ipython-input-2-4171917840.py:278(find_bubble_contours)\n","        2    0.215    0.107    0.215    0.107 {findContours}\n","        1    0.182    0.182    0.185    0.185 /tmp/ipython-input-2-4171917840.py:236(remove_duplicate_contours)\n","    23049    0.134    0.000    0.134    0.000 {approxPolyDP}\n","        1    0.129    0.129    0.129    0.129 {imread}\n","       98    0.101    0.001    0.101    0.001 {warpPerspective}\n","        1    0.001    0.001    0.039    0.039 /tmp/ipython-input-2-4171917840.py:427(generate_labels_and_decode)\n","     4442    0.005    0.000    0.027    0.000 /tmp/ipython-input-2-4171917840.py:227(get_contour_center)\n","    24725    0.022    0.000    0.022    0.000 {arcLength}\n","     4442    0.022    0.000    0.022    0.000 {moments}\n","        1    0.001    0.001    0.018    0.018 /tmp/ipython-input-2-4171917840.py:694(draw_labeled_results)\n","        2    0.017    0.009    0.017    0.009 {GaussianBlur}\n","        4    0.001    0.000    0.017    0.004 /tmp/ipython-input-2-4171917840.py:339(map_contours_to_grid)\n","\n","\n"]}],"source":["import cProfile\n","import pstats\n","\n","if __name__ == \"__main__\":\n","    input_omr = 'JEE_MCQ2.jpg'\n","    omr_template = \"JEE_MCQ_template.json\"\n","    limit = {'Physics_MCQ': 25, 'Chemistry_MCQ': 25, 'Maths_MCQ': 25}\n","\n","    profiler = cProfile.Profile()\n","    profiler.enable()\n","\n","    answer_sheet, results = check_answers(\n","              input_omr = input_omr,\n","              solutions_json = 'solutions.json',\n","              omr_template = omr_template,\n","              question_limit = limit,\n","              if_correct=4,\n","              if_wrong=-1,\n","              thresh_size=201,\n","              aspect_ratio_tolerance=1,\n","              check_orientation=True\n","              )\n","    # print(json.dumps(results, indent = 4))\n","\n","    profiler.disable()\n","    stats = pstats.Stats(profiler).sort_stats('cumtime')\n","    stats.print_stats(20) # Print top 20 functions by cumulative time"]}],"metadata":{"colab":{"name":"","provenance":[{"file_id":"1cONeWIvz16Ldlck7kEIHQ3fVgPwmX36L","timestamp":1758030706879},{"file_id":"1rHEgO8Y9cPz8R8w1FQmBrsBNYfP-UhSW","timestamp":1747916460536}],"version":""},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}